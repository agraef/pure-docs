

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Pure-Sql3 &mdash; Pure Language and Library Documentation</title>
    
    <link rel="stylesheet" href="_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.58',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/sidebar.js"></script>
    <link rel="top" title="Pure Language and Library Documentation" href="index.html" />
    <link rel="next" title="Pure-XML - XML/XSLT interface" href="pure-xml.html" />
    <link rel="prev" title="Pure-ODBC - ODBC interface for the Pure programming language" href="pure-odbc.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="pure-modindex.html" title="Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="pure-xml.html" title="Pure-XML - XML/XSLT interface"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="pure-odbc.html" title="Pure-ODBC - ODBC interface for the Pure programming language"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Pure Language and Library Documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="module-sql3">
<span id="pure-sql3"></span><h1>Pure-Sql3<a class="headerlink" href="#module-sql3" title="Permalink to this headline">¶</a></h1>
<p>Version 0.4, September 08, 2013</p>
<div class="line-block">
<div class="line">Peter Summerland &lt;<a class="reference external" href="mailto:p&#46;summerland&#37;&#52;&#48;gmail&#46;com">p<span>&#46;</span>summerland<span>&#64;</span>gmail<span>&#46;</span>com</a>&gt;</div>
<div class="line">Albert Graef &lt;<a class="reference external" href="mailto:aggraef&#37;&#52;&#48;gmail&#46;com">aggraef<span>&#64;</span>gmail<span>&#46;</span>com</a>&gt;</div>
</div>
<p>This document describes <strong>Sql3</strong>, a <a class="reference external" href="http://www.sqlite.org">SQLite</a> module for the <a class="reference external" href="http://purelang.bitbucket.org">Pure</a>
programming language.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a><ul>
<li><a class="reference internal" href="#simple-example" id="id2">Simple Example</a></li>
<li><a class="reference internal" href="#more-examples" id="id3">More Examples</a></li>
<li><a class="reference internal" href="#sqlite-documentation" id="id4">SQLite Documentation</a></li>
<li><a class="reference internal" href="#sqlite3-the-sqlite-command-line-utility" id="id5">Sqlite3 - The SQLite Command-Line Utility</a></li>
</ul>
</li>
<li><a class="reference internal" href="#copying" id="id6">Copying</a></li>
<li><a class="reference internal" href="#installation" id="id7">Installation</a></li>
<li><a class="reference internal" href="#data-structure" id="id8">Data Structure</a></li>
<li><a class="reference internal" href="#core-database-operations" id="id9">Core Database Operations</a><ul>
<li><a class="reference internal" href="#database-connections" id="id10">Database Connections</a><ul>
<li><a class="reference internal" href="#opening-a-database-connection" id="id11">Opening a Database Connection</a></li>
<li><a class="reference internal" href="#failure-to-open-a-database-connection" id="id12">Failure to Open a Database Connection</a></li>
<li><a class="reference internal" href="#testing-a-db-ptr" id="id13">Testing a db_ptr</a></li>
<li><a class="reference internal" href="#closing-a-database-connection" id="id14">Closing a Database Connection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#prepared-statements" id="id15">Prepared Statements</a><ul>
<li><a class="reference internal" href="#constructing-prepared-statements" id="id16">Constructing Prepared Statements</a></li>
<li><a class="reference internal" href="#testing-a-stmt-ptr" id="id17">Testing a stmt_ptr</a></li>
<li><a class="reference internal" href="#executing-prepared-statements" id="id18">Executing Prepared Statements</a></li>
<li><a class="reference internal" href="#executing-lazily" id="id19">Executing Lazily</a></li>
<li><a class="reference internal" href="#executing-directly-on-a-db-ptr" id="id20">Executing Directly on a db_ptr</a></li>
<li><a class="reference internal" href="#executing-against-a-busy-database" id="id21">Executing Against a Busy Database</a></li>
<li><a class="reference internal" href="#grouping-execution-with-transactions" id="id22">Grouping Execution with Transactions</a></li>
<li><a class="reference internal" href="#finalizing-prepared-statements" id="id23">Finalizing Prepared Statements</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exceptions" id="id24">Exceptions</a><ul>
<li><a class="reference internal" href="#sqlite-error-codes" id="id25">SQLite Error Codes</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-features" id="id26">Advanced Features</a><ul>
<li><a class="reference internal" href="#custom-sql-functions" id="id27">Custom SQL Functions</a><ul>
<li><a class="reference internal" href="#scalar-sql-functions" id="id28">Scalar SQL Functions</a></li>
<li><a class="reference internal" href="#aggregate-sql-functions" id="id29">Aggregate SQL Functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#accessing-the-rest-of-sqlite-s-c-interface" id="id30">Accessing the Rest of SQLite&#8217;s C Interface</a></li>
<li><a class="reference internal" href="#custom-binding-types-for-prepared-statements" id="id31">Custom Binding Types for Prepared Statements</a></li>
</ul>
</li>
<li><a class="reference internal" href="#threading-modes" id="id32">Threading Modes</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>SQLite is a software library that implements an easy to use,
self-contained, serverless, zero-configuration, transactional SQL
database engine. SQLite is not intended to be an enterprise database
engine like Oracle or PostgreSQL. Instead, SQLite strives to be small,
fast, reliable, and above all simple. See <a class="reference external" href="http://www.sqlite.org/whentouse.html">Appropriate Uses For SQLite</a>.</p>
<p>Sql3 is a wrapper around SQLite&#8217;s C interface that provides Pure
programmers access to almost all of SQLite&#8217;s features, including many
that are not available through Pure&#8217;s generic ODBC interface.</p>
<div class="section" id="simple-example">
<h3><a class="toc-backref" href="#id2">Simple Example</a><a class="headerlink" href="#simple-example" title="Permalink to this headline">¶</a></h3>
<p>Here is a simple example that opens a database file &#8220;readme.db&#8221;
(creating it if it does not exist), adds a table &#8220;RM&#8221;, populates &#8220;RM&#8221;
and executes a query.</p>
<div class="highlight-pure"><div class="highlight"><pre>pure-sql3$&gt; pure -q
<span class="gp">&gt;</span>

<span class="gp">&gt; </span><span class="kr">using</span> sql3<span class="p">;</span> <span class="kr">using</span> <span class="kr">namespace</span> sql3<span class="p">;</span>

<span class="gp">&gt; </span><span class="kr">let</span> dbp = open <span class="s">&quot;readme.db&quot;</span><span class="p">;</span>

<span class="gp">&gt; </span>exec dbp <span class="s">&quot;create table if not exists RM (name text, age integer)&quot;</span><span class="p">;</span>

<span class="gp">&gt; </span>exec dbp <span class="s">&quot;delete from RM&quot;</span><span class="p">;</span>

<span class="gp">&gt; </span><span class="kr">let</span> sp1 = prep dbp <span class="s">&quot;ci&quot;</span> <span class="s">&quot;insert into RM values (?,?)&quot;</span><span class="p">;</span>

<span class="gp">&gt; </span>exec sp1 (<span class="s">&quot;Sam&quot;</span>,<span class="mi">20</span>)<span class="p">;</span>

<span class="gp">&gt; </span>exec sp1 (<span class="s">&quot;Fred&quot;</span>,<span class="mi">22</span>)<span class="p">;</span>

<span class="gp">&gt; </span><span class="kr">let</span> sp2 = prep dbp <span class="s">&quot;ci:i&quot;</span> <span class="s">&quot;select * from RM where age &gt; ?&quot;</span><span class="p">;</span>

<span class="gp">&gt; </span>exec sp2 <span class="mi">18</span><span class="p">;</span>
[[<span class="s">&quot;Sam&quot;</span>,<span class="mi">20</span>],[<span class="s">&quot;Fred&quot;</span>,<span class="mi">22</span>]]
</pre></div>
</div>
<p>The Sql3 functions, <a class="reference internal" href="#sql3::open" title="sql3::open"><tt class="xref pure pure-func docutils literal"><span class="pre">open</span></tt></a>, <a class="reference internal" href="#sql3::prep" title="sql3::prep"><tt class="xref pure pure-func docutils literal"><span class="pre">prep</span></tt></a> and <a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a> encapsulate
the core functionality of SQLite, and in many cases are all you need to use
SQLite effectively.</p>
</div>
<div class="section" id="more-examples">
<h3><a class="toc-backref" href="#id3">More Examples</a><a class="headerlink" href="#more-examples" title="Permalink to this headline">¶</a></h3>
<p>The examples subdirectory of pure-Sql3 contains several files that
further illustrate basic usage as well as some of Sql3&#8217;s more
sophisticated features. These include readme.pure, a short file that
contains the examples included herein. If you are using emacs pure-mode
you can load readme.pure into a buffer and execute the examples line by
line (pressing C-c C-c) (as well as experiment as you go).</p>
</div>
<div class="section" id="sqlite-documentation">
<h3><a class="toc-backref" href="#id4">SQLite Documentation</a><a class="headerlink" href="#sqlite-documentation" title="Permalink to this headline">¶</a></h3>
<p>SQLite&#8217;s home page provides excellent documentation regarding its SQL
dialect as well as its C interface. Comments in this document
regarding SQLite are not meant to be a substitute for the actual
documentation and should not be relied upon, other than as general
observations which may or may not be accurate.  The best way to use
Sql3 is to get familiar with SQLite and its C interface and go
directly to the <a class="reference external" href="http://www.sqlite.org/sitemap.html">SQLite Site Map</a> for authoritative answers to any
specific questions that you might have.</p>
<p>In the rest of this document, it is assumed the reader has some
familiarity with SQLite and has read <a class="reference external" href="http://www.sqlite.org/cintro.html">An Introduction To The SQLite
C/C++ Interface</a>.</p>
</div>
<div class="section" id="sqlite3-the-sqlite-command-line-utility">
<h3><a class="toc-backref" href="#id5">Sqlite3 - The SQLite Command-Line Utility</a><a class="headerlink" href="#sqlite3-the-sqlite-command-line-utility" title="Permalink to this headline">¶</a></h3>
<p>The SQLite library includes a really nice command-line utility named
sqlite3 (or sqlite3.exe on Windows) that allows the user to manually
enter and execute SQL statements against a SQLite database (and much
more).</p>
<p>This tool is an invaluable aid when working with SQLite in general and
with Sql3 in the Pure interpreter in particular. For example, after
entering the Pure statements from the Simple Example above, you could
start a new terminal, cd to pure-sql3, type &#8220;sqlite3 readme.db&#8221; at the
prompt, and see the effect the Pure statements had on the database:</p>
<div class="highlight-sql"><pre>pure-sql3$&gt; sqlite3 readme.db
SQLite version 3.6.16
Enter ".help" for instructions
Enter SQL statements terminated with a ";"

sqlite&gt; select * from RM;
Sam|20
Fred|22</pre>
</div>
<p>For bottom up REPL development, sqlite3 and Pure are an excellent
combination.</p>
</div>
</div>
<div class="section" id="copying">
<h2><a class="toc-backref" href="#id6">Copying</a><a class="headerlink" href="#copying" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">Copyright (c) 2010 by Peter Summerland &lt;<a class="reference external" href="mailto:p&#46;summerland&#37;&#52;&#48;gmail&#46;com">p<span>&#46;</span>summerland<span>&#64;</span>gmail<span>&#46;</span>com</a>&gt;.</div>
<div class="line">Copyright (c) 2010 by Albert Graef &lt;<a class="reference external" href="mailto:aggraef&#37;&#52;&#48;gmail&#46;com">aggraef<span>&#64;</span>gmail<span>&#46;</span>com</a>&gt;.</div>
</div>
<p>All rights reserved.</p>
<p>Sql3 is free software: you can redistribute it and/or modify it
under the terms of the New BSD License, often referred to as the 3
clause BSD license.  Sql3 is distributed in the hope that it will be
useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</p>
<p>Please see the COPYING file for the actual license applicable to Sql3.</p>
</div>
<div class="section" id="installation">
<h2><a class="toc-backref" href="#id7">Installation</a><a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>Get the latest source from
<a class="reference external" href="https://bitbucket.org/purelang/pure-lang/downloads/pure-sql3-0.4.tar.gz">https://bitbucket.org/purelang/pure-lang/downloads/pure-sql3-0.4.tar.gz</a>.</p>
<p>Unless you already have them on your machine, download SQLite and
sqlite3 from the SQLite website and install as indicated. To install
Sql3, cd to the pure-sql3 directory, run <tt class="docutils literal"><span class="pre">make</span></tt>, and then run <tt class="docutils literal"><span class="pre">sudo</span>
<span class="pre">make</span> <span class="pre">install</span></tt> (on Linux).</p>
</div>
<div class="section" id="data-structure">
<h2><a class="toc-backref" href="#id8">Data Structure</a><a class="headerlink" href="#data-structure" title="Permalink to this headline">¶</a></h2>
<p>From a client&#8217;s perspective, the most important of SQLite&#8217;s data structures
are the database connection object &#8220;sqlite3&#8221; and the prepared statement object
&#8220;sqlite3_stmt&#8221;. These are opaque data structures that are made available to
users of SQLite&#8217;s C interface via pointers, sqlite3* and sqlite3_stmt*. At
appropriate times, Sql3 creates &#8220;cooked&#8221; versions of these pointers that can
be used (with care) to call native C functions exposed by SQLite&#8217;s C
interface.</p>
<p>Sql3 introduces two new data types, &#8220;db_ptr&#8221; and &#8220;stmt_ptr&#8221; which refer to the
cooked versions of sqlite3* and sqlite3_stmt*, respectively. These two
new data types are defined using :func: <strong class="dfn">type</strong>, and therefore can be used as
type tags in rule patterns or as the first parameter passed to in the typep
function. It follows that all db_ptrs are sqlite3* pointers and all stmt_ptrs
are sqlite3_stmt* pointers. Thus, using dbp and sp1 from the introductory
example:</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span>typep db_ptr dbp, pointer_type dbp<span class="p">;</span>
<span class="mi">1</span>, <span class="s">&quot;sqlite3*&quot;</span>

<span class="gp">&gt; </span>typep stmt_ptr sp1, pointer_type sp1<span class="p">;</span>
<span class="mi">1</span>, <span class="s">&quot;sqlite3_stmt*&quot;</span>
</pre></div>
</div>
<p>The converse, of course, is not true, as SQLite knows nothing about Sql3, and
db_ptrs and stmt_ptrs carry other information in addtion to the underlying
pointers provided to them by SQLite.</p>
</div>
<div class="section" id="core-database-operations">
<h2><a class="toc-backref" href="#id9">Core Database Operations</a><a class="headerlink" href="#core-database-operations" title="Permalink to this headline">¶</a></h2>
<p>The core database operations are (a) opening and closing database
connections and (b) preparing, executing and closing prepared
statements.</p>
<div class="section" id="database-connections">
<h3><a class="toc-backref" href="#id10">Database Connections</a><a class="headerlink" href="#database-connections" title="Permalink to this headline">¶</a></h3>
<p>Generally speaking, the first step in accessing a database is to
obtain a db_ptr that references a database connection object. Once the
db_ptr is obtained, it can be used to construct prepared statements
for updating and querying the underlying database. The last step is
usually to close the database connection (although this is will be done
automatically by Sql3 when the db_ptr goes out of scope).</p>
<div class="section" id="opening-a-database-connection">
<h4><a class="toc-backref" href="#id11">Opening a Database Connection</a><a class="headerlink" href="#opening-a-database-connection" title="Permalink to this headline">¶</a></h4>
<p>In Sql3 <a class="reference internal" href="#sql3::open" title="sql3::open"><tt class="xref pure pure-func docutils literal"><span class="pre">open</span></tt></a> constructs a database connection and returns a db_ptr
that refers to the connection.</p>
<dl class="function">
<dt id="sql3::open">
<tt class="descclassname">sql3::</tt><tt class="descname">open</tt> (file_path::string [,access_mode::int[,custom_bindings]])<a class="headerlink" href="#sql3::open" title="Permalink to this definition">¶</a></dt>
<dd><p>opens a SQLite database file whose name is given by the file_path argument
and returns a db_ptr for the associated database connection object created
by SQLite.</p>
</dd></dl>

<p>Example:</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span> <span class="kr">let</span> dbp2 = open <span class="s">&quot;abc.db&quot;</span><span class="p">;</span> dbp2<span class="p">;</span>
<span class="kt">#&lt;pointer 0x992dff8&gt;</span>
</pre></div>
</div>
<p>If the filename is &#8221;:memory:&#8221; a private, temporary in-memory database
is created for the connection.</p>
<p>The basic access modes are:</p>
<ul class="simple">
<li>SQLITE_OPEN_READONLY - the database is opened in read-only mode. If the
database does not already exist, an error is returned.</li>
<li>SQLITE_OPEN_READWRITE - the database is opened for reading and writing if
possible, or reading only if the file is write protected by the operating
system. In either case the database must already exist, otherwise an
error is returned.</li>
<li>SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE - the database is opened for
reading and writing, and is creates it if it does not already exist. This
is the default value that is used if the flags argument is omitted.</li>
<li>SQLITE_OPEN - an alias for SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE
provided by Sql3.</li>
</ul>
<p>These flags can be combined with SQLITE_OPEN_NOMUTEX
SQLITE_OPEN_FULLMUTEX SQLITE_OPEN_SHAREDCACHE SQLITE_OPEN_PRIVATECACHE
to control SQLite&#8217;s threading and shared cache features. All of these
flags are exported by Sql3.</p>
<p>The optional custom_bindings argument allows the user to set up
customized binding and fetching behavior for prepared statements
associated with the returned db_ptr. (See <a class="reference internal" href="#custom-binding-types-for-prepared-statements">Custom Binding Types for
Prepared Statements</a>)</p>
</div>
<div class="section" id="failure-to-open-a-database-connection">
<h4><a class="toc-backref" href="#id12">Failure to Open a Database Connection</a><a class="headerlink" href="#failure-to-open-a-database-connection" title="Permalink to this headline">¶</a></h4>
<p>If SQLite cannot open the connection, it still returns a pointer to a
database connection object that must be closed. In this case, <a class="reference internal" href="#sql3::open" title="sql3::open"><tt class="xref pure pure-func docutils literal"><span class="pre">open</span></tt></a>
automatically closes the the connection object and then throws an
exception. E.g.,:</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span><span class="nb">catch</span> error (open (<span class="s">&quot;RM_zyx.db&quot;</span>,SQLITE_OPEN_READONLY))<span class="p">;</span>
error (sql3<span class="p">::</span>db_error <span class="mi">14</span> <span class="s">&quot;unable to open database file [open RM_zyx.db]&quot;</span>)
</pre></div>
</div>
<p>Apparently, SQLite does not verify that a file is a valid SQLite
database when it opens a connection. However, if the file is corrupted
SQLite will return an error when the connection is used.</p>
</div>
<div class="section" id="testing-a-db-ptr">
<h4><a class="toc-backref" href="#id13">Testing a db_ptr</a><a class="headerlink" href="#testing-a-db-ptr" title="Permalink to this headline">¶</a></h4>
<p>You can test any object to see if it is a db_ptr using (typep db_ptr):</p>
<dl class="function">
<dt id="typep/sql3dbptr">
<tt class="descname">typep</tt> db_ptr x<a class="headerlink" href="#typep/sql3dbptr" title="Permalink to this definition">¶</a></dt>
<dd><p>returns 1 if x is a db_ptr returned by open, and 0 if it is not.</p>
</dd></dl>

<p>You can also determine if a db_ptr&#8217;s data connection is open.</p>
<dl class="function">
<dt id="sql3::is_open">
<tt class="descclassname">sql3::</tt><tt class="descname">is_open</tt> dbp::db_ptr<a class="headerlink" href="#sql3::is_open" title="Permalink to this definition">¶</a></dt>
<dd><p>returns 1 if the database connection referenced by dbp is open.</p>
</dd></dl>

</div>
<div class="section" id="closing-a-database-connection">
<h4><a class="toc-backref" href="#id14">Closing a Database Connection</a><a class="headerlink" href="#closing-a-database-connection" title="Permalink to this headline">¶</a></h4>
<p>When a database connection object is no longer needed, it should be closed
so that SQLite can free the associated resources.</p>
<dl class="function">
<dt id="sql3::close">
<tt class="descclassname">sql3::</tt><tt class="descname">close</tt> dbp::db_ptr<a class="headerlink" href="#sql3::close" title="Permalink to this definition">¶</a></dt>
<dd><p>if the database connection referenced by the db_ptr dbp is open,
close it using sqlite3_close; otherwise do nothing.</p>
</dd></dl>

<p>Before calling <tt class="docutils literal"><span class="pre">sqlite3_close</span></tt>, <a class="reference internal" href="#sql3::close" title="sql3::close"><tt class="xref pure pure-func docutils literal"><span class="pre">close</span></tt></a> finalizes all prepared
statements associated with the connection being closed. Sql3 will
detect and throw a db_error if an attempt is subsequently made to
execute a statement associated with the closed database connection.</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span><span class="kr">let</span> dbp2_sp = prep dbp2 <span class="s">&quot;ci:&quot;</span> <span class="s">&quot;select * from RM&quot;</span><span class="p">;</span>

<span class="gp">&gt; </span>exec dbp2_sp ()<span class="p">;</span>
[[<span class="s">&quot;Sam&quot;</span>,<span class="mi">20</span>],[<span class="s">&quot;Fred&quot;</span>,<span class="mi">22</span>]]

<span class="gp">&gt; </span>close dbp2<span class="p">;</span>

<span class="gp">&gt; </span><span class="nb">catch</span> error (exec dbp2_sp)<span class="p">;</span>
error (sql3<span class="p">::</span>db_error <span class="mi">0</span> <span class="s">&quot;Attempt to exec on a closed db_ptr.&quot;</span>)
</pre></div>
</div>
<p>If a db_ptr goes out of scope, Sql3 will automatically call <tt class="docutils literal"><span class="pre">sqlite3_close</span></tt>
to close the referenced database connection, but only if the connection has
not already been closed by <a class="reference internal" href="#sql3::close" title="sql3::close"><tt class="xref pure pure-func docutils literal"><span class="pre">close</span></tt></a>. Thus, for example, it is not
necessary to use a catch statement to ensure that Sqlite3 resources are
properly finalized when a db_ptr is passed into code that could throw an
exception.</p>
<p>When debugging, this activity can be observed by editing sql3.pure,
changing &#8220;const SHOW_OPEN_CLOSE = 0;&#8221; to &#8220;const SHOW_OPEN_CLOSE = 1;&#8221;
and running sudo make install in the pure-sql3 directory. This will
cause a message to be printed whenever a db_ptr or stmt_ptr is created
or finalized.</p>
<p>N.B. You should never call the native C interface function``sqlite3_close``
with a db_ptr. If the referenced database connection is closed by such a call,
a subsequent call to <a class="reference internal" href="#sql3::close" title="sql3::close"><tt class="xref pure pure-func docutils literal"><span class="pre">close</span></tt></a> on this db_ptr (including the call that
will automatically occur when the db_ptr goes out of scope) will cause a seg
fault.</p>
</div>
</div>
<div class="section" id="prepared-statements">
<h3><a class="toc-backref" href="#id15">Prepared Statements</a><a class="headerlink" href="#prepared-statements" title="Permalink to this headline">¶</a></h3>
<p>The native SQLite C interface provides five core functions needed to execute a
SQL statement.</p>
<ul class="simple">
<li>sqlite3_prepare_v2</li>
<li>sqlite3_bind</li>
<li>sqlite3_step</li>
<li>sqlite3_column</li>
<li>sqlite3_finalize</li>
</ul>
<p>Using the C interface, the basic procedure is to prepare a statement using
<tt class="docutils literal"><span class="pre">sqlite3_prepare_v2</span></tt>, bind its parameters using <tt class="docutils literal"><span class="pre">sqlite3_bind</span></tt>, step it
using <tt class="docutils literal"><span class="pre">sqlite3_step</span></tt> one or more times until it is done and then finalize it
using <tt class="docutils literal"><span class="pre">sqlite3_finalize</span></tt>. Each time <tt class="docutils literal"><span class="pre">sqlite3_step</span></tt> returns SQLITE_ROW, use
<tt class="docutils literal"><span class="pre">sqlite3_column</span></tt> to fetch the row&#8217;s values. Here <tt class="docutils literal"><span class="pre">sqlite3_bind</span></tt> and
<tt class="docutils literal"><span class="pre">sqlite3_column</span></tt> represent families of bind and column functions, rather
than actual functions, with one member for each of the basic data types
recognized by SQLite. Thus, for example, <tt class="docutils literal"><span class="pre">sqlite_bind_double</span></tt> is the
function one would use to bind a prepared statement with an argument of type
double.</p>
<p>Sql3 encapsulates these procedures in four functions: <a class="reference internal" href="#sql3::prep" title="sql3::prep"><tt class="xref pure pure-func docutils literal"><span class="pre">prep</span></tt></a>,
<a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a>, <a class="reference internal" href="#sql3::lexec" title="sql3::lexec"><tt class="xref pure pure-func docutils literal"><span class="pre">lexec</span></tt></a> and <a class="reference internal" href="#sql3::finalize" title="sql3::finalize"><tt class="xref pure pure-func docutils literal"><span class="pre">finalize</span></tt></a>.</p>
<div class="section" id="constructing-prepared-statements">
<h4><a class="toc-backref" href="#id16">Constructing Prepared Statements</a><a class="headerlink" href="#constructing-prepared-statements" title="Permalink to this headline">¶</a></h4>
<p>In Sql3 you can use <a class="reference internal" href="#sql3::prep" title="sql3::prep"><tt class="xref pure pure-func docutils literal"><span class="pre">prep</span></tt></a> to construct a prepared statement and
obtain a stmt_ptr that refers to it.</p>
<dl class="function">
<dt id="sql3::prep">
<tt class="descclassname">sql3::</tt><tt class="descname">prep</tt> dbp::db_ptr binding_string::string sql_statement::string<a class="headerlink" href="#sql3::prep" title="Permalink to this definition">¶</a></dt>
<dd><p>constructs a prepared statement object and returns a stmt_ptr that
references it. <tt class="docutils literal"><span class="pre">dbp</span></tt> must be a db_ptr or the rule will not
match. <tt class="docutils literal"><span class="pre">sql_statement</span></tt> is the SQL statement that will be executed
when the prepared statement is passed to <a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a>.</p>
</dd></dl>

<p>Basically, <a class="reference internal" href="#sql3::prep" title="sql3::prep"><tt class="xref pure pure-func docutils literal"><span class="pre">prep</span></tt></a> just passes <tt class="docutils literal"><span class="pre">dbp</span></tt> and <tt class="docutils literal"><span class="pre">sql_statement</span></tt> on to
<tt class="docutils literal"><span class="pre">sqlite3_prepare_v2</span></tt> and returns a sentry guarded version of the
sqlite3_stmt* it receives back from <tt class="docutils literal"><span class="pre">sqlite3_prepare_v2</span></tt>. SQL
statements passed to <a class="reference internal" href="#sql3::prep" title="sql3::prep"><tt class="xref pure pure-func docutils literal"><span class="pre">prep</span></tt></a> (and <tt class="docutils literal"><span class="pre">sqlite3_prepare_v2</span></tt>) can have
argument placeholders, indicated by &#8221;?&#8221;, &#8221;?nnn&#8221;, &#8221;:AAA&#8221;, etc, in which
case the argument placeholders must be bound to values using
<tt class="docutils literal"><span class="pre">sqlite_bind</span></tt> before the prepared statement is passed to
<tt class="docutils literal"><span class="pre">sqlite3_step</span></tt>.  Hence the <tt class="docutils literal"><span class="pre">binding_string</span></tt>, which is used by Sql3
to determine how to bind the prepared statement&#8217;s argument
placeholders, if any. The binding string also tells Sql3 how to fetch
values in the <tt class="docutils literal"><span class="pre">sqlite3_column</span></tt> phase of the basic prepare, bind,
step, fetch, finalize cycle dictated by the SQlite C interface.</p>
<p>In the following two examples, the &#8220;c&#8221; and &#8220;i&#8221; in the binding strings
indicate that (a) a string and an int will be used to bind <tt class="docutils literal"><span class="pre">sp1</span></tt>,(b)
an int will be used to bind <tt class="docutils literal"><span class="pre">sp2</span></tt> and (c) <tt class="docutils literal"><span class="pre">sp2</span></tt>, when executed,
will return a result set in the form of a list of sublists each of
which contains a string and an int.</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span><span class="kr">let</span> sp1 = prep dbp <span class="s">&quot;ci&quot;</span> <span class="s">&quot;insert into RM values (?,?)&quot;</span><span class="p">;</span>

<span class="gp">&gt; </span><span class="kr">let</span> sp2 = prep dbp <span class="s">&quot;ci:i&quot;</span> <span class="s">&quot;select * from RM where age &gt; ?&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>In general, the characters in the type string before the &#8221;:&#8221;, if any,
indicate the types in the result set. Those that occur after the &#8221;:&#8221;,
if any, indicate the types of the arguments used to bind the prepared
statement object. If the type string does not contain a &#8221;:&#8221;, the
characters in the type string, if any, are the types of binding
arguments.</p>
<p>Sql3 provides the following set of &#8220;core&#8221; binding types:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="52%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Pure Argument</th>
<th class="head">SQLite Type</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>b</td>
<td>(int, pointer)</td>
<td>blob</td>
</tr>
<tr class="row-odd"><td>c</td>
<td>string</td>
<td>text (utf8)</td>
</tr>
<tr class="row-even"><td>d</td>
<td>double</td>
<td>float</td>
</tr>
<tr class="row-odd"><td>i</td>
<td>int</td>
<td>int</td>
</tr>
<tr class="row-even"><td>k</td>
<td>int or bigint</td>
<td>int64</td>
</tr>
<tr class="row-odd"><td>l</td>
<td>bigint</td>
<td>blob</td>
</tr>
<tr class="row-even"><td>n</td>
<td>Sql3::SQLNULL</td>
<td>NULL</td>
</tr>
<tr class="row-odd"><td>x</td>
<td>expression</td>
<td>blob</td>
</tr>
<tr class="row-even"><td>v</td>
<td>variant</td>
<td>variant</td>
</tr>
</tbody>
</table>
<p>The &#8220;<strong>b</strong>&#8221; or blob type is different from the rest in that the Pure
argument is specified as a pair. The first element of the pair
indicates the length in bytes of the object to be stored and the
second element indicates its location in memory. The &#8220;<strong>c</strong>&#8221; type
stands for string (as in &#8220;char*&#8221;), &#8220;<strong>d</strong>&#8221; stands for double and
&#8220;<strong>i</strong>&#8221; stands for int.  The &#8220;<strong>k</strong>&#8221; type stands for &#8220;key&#8221; and maps
Pure ints and bigints (within the range of int64) to int64 values in
the database.  This type is useful when dealing with SQLite&#8217;s &#8220;integer
primary keys&#8221; and &#8220;rowids&#8221; both of which are int64.  The &#8220;<strong>l</strong>&#8221; type,
in contrast applies to all bigints (and not to ints) and it maps
bigints onto blobs, which are generally meaningless in SQL math
expressions.  The &#8220;<strong>n</strong>&#8221; type can only appear on the binding side of
a type string. The &#8220;<strong>v</strong>&#8221; type stands for any of &#8220;b&#8221;, &#8220;c&#8221;, &#8220;d&#8221;, &#8220;i&#8221;
or &#8220;n&#8221;, based on the type of the binding argument. A &#8220;v&#8221; type will be
fetched from SQLite according to the native SQLite column type of the
corresponding column.  The &#8220;<strong>x</strong>&#8221; type is used to store and
reconstruct Pure expressions as binary objects, using the
<a class="reference internal" href="purelib.html#val/blob" title="val"><tt class="xref pure pure-func docutils literal"><span class="pre">val</span></tt></a> and <a class="reference internal" href="purelib.html#blob" title="blob"><tt class="xref pure pure-func docutils literal"><span class="pre">blob</span></tt></a> functions provided by the Pure
prelude.</p>
<p>Users can define custom binding types and pass them as a third
parameter to <a class="reference internal" href="#sql3::open" title="sql3::open"><tt class="xref pure pure-func docutils literal"><span class="pre">open</span></tt></a>. The resulting db_ptr can be used with the
custom binding types to construct prepared statements using <a class="reference internal" href="#sql3::prep" title="sql3::prep"><tt class="xref pure pure-func docutils literal"><span class="pre">prep</span></tt></a>.</p>
</div>
<div class="section" id="testing-a-stmt-ptr">
<h4><a class="toc-backref" href="#id17">Testing a stmt_ptr</a><a class="headerlink" href="#testing-a-stmt-ptr" title="Permalink to this headline">¶</a></h4>
<p>You can determine if a given expression is a stmt_ptr using typep.</p>
<dl class="function">
<dt id="typep/sql3stmtptr">
<tt class="descname">typep</tt> stmt_ptr x<a class="headerlink" href="#typep/sql3stmtptr" title="Permalink to this definition">¶</a></dt>
<dd><p>returns 1 if <tt class="docutils literal"><span class="pre">x</span></tt> is a stmt_ptr, otherwise returns 0.</p>
</dd></dl>

</div>
<div class="section" id="executing-prepared-statements">
<h4><a class="toc-backref" href="#id18">Executing Prepared Statements</a><a class="headerlink" href="#executing-prepared-statements" title="Permalink to this headline">¶</a></h4>
<p>In Sql3, the bind, step, column, step, column ... cycle is encapsulated in
the <a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a> and <a class="reference internal" href="#sql3::lexec" title="sql3::lexec"><tt class="xref pure pure-func docutils literal"><span class="pre">lexec</span></tt></a> functions.</p>
<dl class="function">
<dt id="sql3::exec">
<tt class="descclassname">sql3::</tt><tt class="descname">exec</tt> sp::stmt_ptr args<a class="headerlink" href="#sql3::exec" title="Permalink to this definition">¶</a></dt>
<dd><p>use <tt class="docutils literal"><span class="pre">args</span></tt> to bind the prepared statement referenced by <tt class="docutils literal"><span class="pre">sp</span></tt>, execute
it and return the result set as a list. The first parameter, <tt class="docutils literal"><span class="pre">sp</span></tt> must be
a valid stmt_ptr or the rule will fail.</p>
</dd></dl>

<p>The second parameter, <tt class="docutils literal"><span class="pre">args</span></tt>, is a tuple or list of arguments whose
number and type correspond to the bind parameter types specified in
the call to <a class="reference internal" href="#sql3::prep" title="sql3::prep"><tt class="xref pure pure-func docutils literal"><span class="pre">prep</span></tt></a> that produced the first parameter <tt class="docutils literal"><span class="pre">sp</span></tt>.</p>
<p>Thus, using sp1 and sp2 defined in the introductory example:</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span>exec sp1 (<span class="s">&quot;Tom&quot;</span>,<span class="mi">30</span>)<span class="p">;</span>  <span class="c1">//insert Tom</span>
[]

<span class="gp">&gt; </span>exec sp2 <span class="mi">19</span><span class="p">;</span>          <span class="c1">//select age &gt; 19</span>
[[<span class="s">&quot;Sam&quot;</span>,<span class="mi">20</span>],[<span class="s">&quot;Fred&quot;</span>,<span class="mi">22</span>],[<span class="s">&quot;Tom&quot;</span>,<span class="mi">30</span>]]
</pre></div>
</div>
<p>An error is thrown if the args do not correspond to the specified types.</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span><span class="nb">catch</span> error (exec sp2 <span class="s">&quot;a&quot;</span>)<span class="p">;</span>
error (sql3<span class="p">::</span>db_error <span class="mi">0</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;</span><span class="s"> does not have type int&quot;</span>)
</pre></div>
</div>
<p>If a prepared statement does not have any binding parameters,
the call to <a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a> should use <tt class="docutils literal"><span class="pre">()</span></tt> as the binding argument.</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span><span class="kr">let</span> sp3 = prep dbp <span class="s">&quot;c:&quot;</span> <span class="s">&quot;select name from RM&quot;</span><span class="p">;</span>

<span class="gp">&gt; </span>exec sp3 ()<span class="p">;</span>
[[<span class="s">&quot;Sam&quot;</span>],[<span class="s">&quot;Fred&quot;</span>],[<span class="s">&quot;Tom&quot;</span>]]
</pre></div>
</div>
<p>Extra care is required when executing prepared statements that take a
blob argument because it must be a pair. In order to preserve the
tuple as a pair, binding arguments that include a blob should passed
to exec as a list. If passed as a member of a larger tuple, it will be
treated as two arguments due to the nature of tuples.</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span><span class="kr">let</span> blb = (<span class="mi">100</span>,ptr)<span class="p">;</span>

<span class="gp">&gt; </span>(a,blb,c)<span class="p">;</span>
a,<span class="mi">100</span>,ptr,c

<span class="gp">&gt; </span>[a,blb,c]<span class="p">;</span>
[a,(<span class="mi">100</span>,ptr),c]
</pre></div>
</div>
<p>Thus something like &#8220;<tt class="docutils literal"><span class="pre">exec</span> <span class="pre">stpx</span> <span class="pre">[a,blb,c]</span></tt>&#8221; would work fine, while &#8220;<tt class="docutils literal"><span class="pre">exec</span>
<span class="pre">stpx</span> <span class="pre">(a,blb,c)</span></tt>&#8221; would produce a Sql3 binding exception.</p>
</div>
<div class="section" id="executing-lazily">
<h4><a class="toc-backref" href="#id19">Executing Lazily</a><a class="headerlink" href="#executing-lazily" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a> function returns result sets as eager lists which can
sometimes be inefficient or simply not feasible for large result
sets. In such cases it is preferable to use <a class="reference internal" href="#sql3::lexec" title="sql3::lexec"><tt class="xref pure pure-func docutils literal"><span class="pre">lexec</span></tt></a> instead of
<a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a>.</p>
<dl class="function">
<dt id="sql3::lexec">
<tt class="descclassname">sql3::</tt><tt class="descname">lexec</tt> stmp::stmt_ptr args<a class="headerlink" href="#sql3::lexec" title="Permalink to this definition">¶</a></dt>
<dd><p>same as <a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a> except that it returns a lazy list.</p>
</dd></dl>

<p>Example:</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span>lexec sp2 <span class="mi">19</span><span class="p">;</span>
[<span class="s">&quot;Sam&quot;</span>,<span class="mi">20</span>]:<span class="kt">#&lt;thunk 0xb6475ab0&gt;</span>
</pre></div>
</div>
<p>Note that no changes to <tt class="docutils literal"><span class="pre">sp2</span></tt> were required. In addition, for most
purposes the lazy list returned by <a class="reference internal" href="#sql3::lexec" title="sql3::lexec"><tt class="xref pure pure-func docutils literal"><span class="pre">lexec</span></tt></a> can be processed by the
same code that processed the eager list returned by <a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a>.</p>
</div>
<div class="section" id="executing-directly-on-a-db-ptr">
<h4><a class="toc-backref" href="#id20">Executing Directly on a db_ptr</a><a class="headerlink" href="#executing-directly-on-a-db-ptr" title="Permalink to this headline">¶</a></h4>
<p>For statements that have no parameters and which do not return results,
<a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a> can be applied to a db_ptr.</p>
<dl class="function">
<dt>
<tt class="descclassname">sql3::</tt><tt class="descname">exec</tt> dbp::db_ptr sql_statement::string</dt>
<dd><p>constructs a temporary prepared statement using <tt class="docutils literal"><span class="pre">sql_statement</span></tt>. The SQL
statement cannot contain argument placeholders and cannot be a select
statement.</p>
</dd></dl>

<p>Example:</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span>exec dbp <span class="s">&quot;create table if not exists RM (name varchar, age integer)&quot;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="executing-against-a-busy-database">
<h4><a class="toc-backref" href="#id21">Executing Against a Busy Database</a><a class="headerlink" href="#executing-against-a-busy-database" title="Permalink to this headline">¶</a></h4>
<p>SQLite allows multiple processes to concurrently read a single
database, but when any process wants to write, it locks the entire
database file for the duration of its update.</p>
<p>When the native SQLite C interface function <tt class="docutils literal"><span class="pre">sqlite3_step</span></tt> (used by
<tt class="docutils literal"><span class="pre">exec</span></tt>) tries to access a file that is locked by another process, it treats
the database as &#8220;busy&#8221; and returns the SQLITE_BUSY error code. If this happens
in a call to <a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a> or <a class="reference internal" href="#sql3::lexec" title="sql3::lexec"><tt class="xref pure pure-func docutils literal"><span class="pre">lexec</span></tt></a>, a <a class="reference internal" href="#sql3::db_busy" title="sql3::db_busy"><tt class="xref pure pure-cons docutils literal"><span class="pre">db_busy</span></tt></a> exception will
be thrown.</p>
<p>You can adjust SQLite&#8217;s behavior using <tt class="docutils literal"><span class="pre">sqlite3_busy_handler</span></tt> or
<tt class="docutils literal"><span class="pre">sqlite3_busy_timeout</span></tt>.</p>
<p>If the statement is a COMMIT or occurs outside of an explicit
transaction, then you can retry the statement. If the statement is not
a COMMIT and occurs within a explicit transaction then you should
rollback the transaction before continuing.</p>
</div>
<div class="section" id="grouping-execution-with-transactions">
<h4><a class="toc-backref" href="#id22">Grouping Execution with Transactions</a><a class="headerlink" href="#grouping-execution-with-transactions" title="Permalink to this headline">¶</a></h4>
<p>No changes can be made to a SQLite database file except within a
transaction. Transactions can be started manually by executing a BEGIN
statement (i.e., exec dbp &#8220;BEGIN&#8221;). Manually started transactions persist
until the next COMMIT or ROLLBACK statement is executed. Transactions are also
ended if an error occurs before the transaction is manually ended using a
COMMIT or ROLLBACK statement. This behavior provides the means make a series
of changes &#8220;atomically.&#8221;</p>
<p>By default, SQLite operates in autocommit mode. In autocommit mode,
any SQL statement that changes the database (basically, anything other
than SELECT) will automatically start a transaction if one is not
already in effect. As opposed to manually started transactions,
automatically started transactions are committed as soon as the
execution of the related statement completes.</p>
<p>The upshot of this, in Sql3 terms, is that unless a transaction is
started manually, the database will be updated each time <a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a> is
called. For a long series of updates or inserts this a can be very
slow. The way to avoid this problem is to manually begin and end
transactions manually.</p>
<p>Sql3 provides the following convenience functions all of which simply
call <a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a> with the appropriate statement. For example <tt class="docutils literal"><span class="pre">begin</span>
<span class="pre">dbp</span></tt> is exactly the same as <tt class="docutils literal"><span class="pre">exec</span> <span class="pre">dbp</span> <span class="pre">&quot;BEGIN&quot;</span></tt>.</p>
<dl class="function">
<dt id="sql3::begin">
<tt class="descclassname">sql3::</tt><tt class="descname">begin</tt> dbp::db_ptr<a class="headerlink" href="#sql3::begin" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="sql3::begin_exclusive">
<tt class="descclassname">sql3::</tt><tt class="descname">begin_exclusive</tt> dbp::db_ptr<a class="headerlink" href="#sql3::begin_exclusive" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="sql3::begin_immediate">
<tt class="descclassname">sql3::</tt><tt class="descname">begin_immediate</tt> dbp::db_ptr<a class="headerlink" href="#sql3::begin_immediate" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="sql3::commit">
<tt class="descclassname">sql3::</tt><tt class="descname">commit</tt> dbp::db_ptr<a class="headerlink" href="#sql3::commit" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="sql3::rollback">
<tt class="descclassname">sql3::</tt><tt class="descname">rollback</tt> dbp::db_ptr<a class="headerlink" href="#sql3::rollback" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="sql3::savepoint">
<tt class="descclassname">sql3::</tt><tt class="descname">savepoint</tt> dbp::db_ptr save_point::string<a class="headerlink" href="#sql3::savepoint" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="sql3::release">
<tt class="descclassname">sql3::</tt><tt class="descname">release</tt> dbp::db_ptr save_point::string<a class="headerlink" href="#sql3::release" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="sql3::rollback_to">
<tt class="descclassname">sql3::</tt><tt class="descname">rollback_to</tt> dbp::db_ptr save_point::string<a class="headerlink" href="#sql3::rollback_to" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Note that transactions created using :func: <strong class="dfn">begin</strong> and :func: <strong class="dfn">commit</strong> do not
nest. For nested transactions, use :func: <strong class="dfn">savepoint</strong> and :func: <strong class="dfn">release</strong>.</p>
</div>
<div class="section" id="finalizing-prepared-statements">
<h4><a class="toc-backref" href="#id23">Finalizing Prepared Statements</a><a class="headerlink" href="#finalizing-prepared-statements" title="Permalink to this headline">¶</a></h4>
<p>When a prepared statement is no longer needed it should be finalized
so that SQLite can free the associated resources.</p>
<dl class="function">
<dt id="sql3::finalize">
<tt class="descclassname">sql3::</tt><tt class="descname">finalize</tt> sp::stmt_ptr<a class="headerlink" href="#sql3::finalize" title="Permalink to this definition">¶</a></dt>
<dd><p>finalize the prepared statement referenced by <tt class="docutils literal"><span class="pre">sp</span></tt>, which must be a
stmt_ptr previously returned by <a class="reference internal" href="#sql3::prep" title="sql3::prep"><tt class="xref pure pure-func docutils literal"><span class="pre">prep</span></tt></a>.</p>
</dd></dl>

<p>Often there is no need to call <a class="reference internal" href="#sql3::finalize" title="sql3::finalize"><tt class="xref pure pure-func docutils literal"><span class="pre">finalize</span></tt></a> for a given stmt_ptr
because it will be automatically called when the stmt_ptr goes out of
scope.</p>
<p>If the stmt_ptr is associated with a database connection that has been
closed (which would have caused an exception to be thrown), an attempt
to finalize it, including the automatic finalization can occur when
stmt_ptr goes out of scope, will cause an exception to be thrown.</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span><span class="nb">catch</span> error (finalize dbp2_sp)<span class="p">;</span>
error (sql3<span class="p">::</span>db_error <span class="mi">0</span> <span class="s">&quot;finalize: STMT attached to a closed db_ptr.&quot;</span>)
</pre></div>
</div>
<p>Multiple calls to <a class="reference internal" href="#sql3::finalize" title="sql3::finalize"><tt class="xref pure pure-func docutils literal"><span class="pre">finalize</span></tt></a> are fine. In contrast, the corresponding
native C interface function, <tt class="docutils literal"><span class="pre">sqlite3_finalize</span></tt> will cause a seg
fault if called with a pointer to a finalized prepared statement
object. This is the main reason why you should never call
<tt class="docutils literal"><span class="pre">sqlite3_finalize</span></tt> with a stmt_ptr. If the prepared statement
referenced by the stmt_ptr is finalized by such a call, a subsequent
call to <a class="reference internal" href="#sql3::finalize" title="sql3::finalize"><tt class="xref pure pure-func docutils literal"><span class="pre">finalize</span></tt></a> with the stmt_ptr (including the call that will
automatically occur when the stmt_ptr goes out of scope) will cause a
seg fault.</p>
</div>
</div>
<div class="section" id="exceptions">
<h3><a class="toc-backref" href="#id24">Exceptions</a><a class="headerlink" href="#exceptions" title="Permalink to this headline">¶</a></h3>
<p>Sql3 throws two types of exceptions, one for outright errors and one
for database &#8220;busy&#8221; conditions.</p>
<dl class="constructor">
<dt id="sql3::db_error">
<em class="property">constructor </em><tt class="descclassname">sql3::</tt><tt class="descname">db_error</tt> ec msg<a class="headerlink" href="#sql3::db_error" title="Permalink to this definition">¶</a></dt>
<dd><p>When a Sql3 function detects an error it throws an exception of the form
&#8220;<tt class="docutils literal"><span class="pre">db_error</span> <span class="pre">ec</span> <span class="pre">msg</span></tt>&#8221; where ec is an error code and msg is the
corresponding error message. If ec&gt;0, the error was detected by SQLite
itself, and ec and msg are those returned by SQLite. If ec==0, the error
was detected by Sql3 and msg is a Sql3 specific description of the
error. E.g.,</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span>db_error_handler (db_error ec msg) = ()
<span class="gp">&gt; </span><span class="kr">when</span>
<span class="gp">&gt; </span>  source = <span class="kr">if</span> ec &gt; <span class="mi">0</span> <span class="kr">then</span> <span class="s">&quot;SQLite&quot;</span> <span class="kr">else</span> <span class="s">&quot;Sql3&quot;</span><span class="p">;</span>
<span class="gp">&gt; </span>  printf <span class="s">&quot;%s db_error: ec %d, %s</span><span class="se">\n</span><span class="s">&quot;</span> (source,ec,msg)<span class="p">;</span>
<span class="gp">&gt; </span><span class="kr">end</span><span class="p">;</span>
<span class="gp">&gt; </span>db_error_handler x = <span class="nb">throw</span> x<span class="p">;</span>

<span class="gp">&gt; </span><span class="nb">catch</span> db_error_handler (exec dbp <span class="s">&quot;select * from NO_TABLE&quot;</span>)<span class="p">;</span>
SQLite db_error: ec <span class="mi">1</span>, no such table: NO_TABLE
</pre></div>
</div>
</dd></dl>

<dl class="constructor">
<dt id="sql3::db_busy">
<em class="property">constructor </em><tt class="descclassname">sql3::</tt><tt class="descname">db_busy</tt> dbp<a class="headerlink" href="#sql3::db_busy" title="Permalink to this definition">¶</a></dt>
<dd><p>Sql3 functions <a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a> and <a class="reference internal" href="#sql3::lexec" title="sql3::lexec"><tt class="xref pure pure-func docutils literal"><span class="pre">lexec</span></tt></a> throw exceptions of the form
&#8220;<tt class="docutils literal"><span class="pre">db_busy</span> <span class="pre">dbp</span></tt>&#8221;, where <tt class="docutils literal"><span class="pre">dbp</span></tt> is a db_ptr, if they are prevented from
executing successfully because the database referenced by <tt class="docutils literal"><span class="pre">dbp</span></tt> is locked
(See <a class="reference internal" href="#executing-against-a-busy-database">Executing Against a Busy Database</a>).</p>
</dd></dl>

<div class="section" id="sqlite-error-codes">
<h4><a class="toc-backref" href="#id25">SQLite Error Codes</a><a class="headerlink" href="#sqlite-error-codes" title="Permalink to this headline">¶</a></h4>
<p>Here is a list, as of January 31, 2011, of SQLite&#8217;s error codes.</p>
<div class="highlight-pure"><div class="highlight"><pre>SQLITE_ERROR        <span class="mi">1</span>   <span class="cm">/* SQL error or missing database */</span>
SQLITE_INTERNAL     <span class="mi">2</span>   <span class="cm">/* Internal logic error in SQLite */</span>
SQLITE_PERM         <span class="mi">3</span>   <span class="cm">/* Access permission denied */</span>
SQLITE_ABORT        <span class="mi">4</span>   <span class="cm">/* Callback routine requested an abort */</span>
SQLITE_BUSY         <span class="mi">5</span>   <span class="cm">/* The database file is locked */</span>
SQLITE_LOCKED       <span class="mi">6</span>   <span class="cm">/* A table in the database is locked */</span>
SQLITE_NOMEM        <span class="mi">7</span>   <span class="cm">/* A malloc() failed */</span>
SQLITE_READONLY     <span class="mi">8</span>   <span class="cm">/* Attempt to write a readonly database */</span>
SQLITE_INTERRUPT    <span class="mi">9</span>   <span class="cm">/* Operation terminated by sqlite3_interrupt()*/</span>
SQLITE_IOERR       <span class="mi">10</span>   <span class="cm">/* Some kind of disk I/O error occurred */</span>
SQLITE_CORRUPT     <span class="mi">11</span>   <span class="cm">/* The database disk image is malformed */</span>
SQLITE_NOTFOUND    <span class="mi">12</span>   <span class="cm">/* NOT USED. Table or record not found */</span>
SQLITE_FULL        <span class="mi">13</span>   <span class="cm">/* Insertion failed because database is full */</span>
SQLITE_CANTOPEN    <span class="mi">14</span>   <span class="cm">/* Unable to open the database file */</span>
SQLITE_PROTOCOL    <span class="mi">15</span>   <span class="cm">/* NOT USED. Database lock protocol error */</span>
SQLITE_EMPTY       <span class="mi">16</span>   <span class="cm">/* Database is empty */</span>
SQLITE_SCHEMA      <span class="mi">17</span>   <span class="cm">/* The database schema changed */</span>
SQLITE_TOOBIG      <span class="mi">18</span>   <span class="cm">/* String or BLOB exceeds size limit */</span>
SQLITE_CONSTRAINT  <span class="mi">19</span>   <span class="cm">/* Abort due to constraint violation */</span>
SQLITE_MISMATCH    <span class="mi">20</span>   <span class="cm">/* Data type mismatch */</span>
SQLITE_MISUSE      <span class="mi">21</span>   <span class="cm">/* Library used incorrectly */</span>
SQLITE_NOLFS       <span class="mi">22</span>   <span class="cm">/* Uses OS features not supported on host */</span>
SQLITE_AUTH        <span class="mi">23</span>   <span class="cm">/* Authorization denied */</span>
SQLITE_FORMAT      <span class="mi">24</span>   <span class="cm">/* Auxiliary database format error */</span>
SQLITE_RANGE       <span class="mi">25</span>   <span class="cm">/* 2nd parameter to sqlite3_bind out of range */</span>
SQLITE_NOTADB      <span class="mi">26</span>   <span class="cm">/* File opened that is not a database file */</span>
</pre></div>
</div>
<p>New error codes may be added in future versions of SQLite. Note that
the SQLite names of the error codes are not exported by the Sql3
module.</p>
</div>
</div>
</div>
<div class="section" id="advanced-features">
<h2><a class="toc-backref" href="#id26">Advanced Features</a><a class="headerlink" href="#advanced-features" title="Permalink to this headline">¶</a></h2>
<p>Sql3&#8217;s advanced features include the ability to implement SQL
functions in Pure, convenient access to the SQLite C interface and
custom binding types.</p>
<div class="section" id="custom-sql-functions">
<h3><a class="toc-backref" href="#id27">Custom SQL Functions</a><a class="headerlink" href="#custom-sql-functions" title="Permalink to this headline">¶</a></h3>
<p>An extremely powerful (albeit complex) feature of the SQLite C
interface is the ability to add new SQL scalar or aggregate
functions. The new functions can be used in SQL statements the in same
way as SQLites&#8217;s prepackaged functions. Sql3 hides the complexity and
seamlessly integrates all of this functionality, :), into Pure via
<a class="reference internal" href="#sql3::create_function" title="sql3::create_function"><tt class="xref pure pure-func docutils literal"><span class="pre">create_function</span></tt></a>. This function is used to register both scalar SQL
functions and aggregate SQL functions with SQlite.</p>
<div class="section" id="scalar-sql-functions">
<h4><a class="toc-backref" href="#id28">Scalar SQL Functions</a><a class="headerlink" href="#scalar-sql-functions" title="Permalink to this headline">¶</a></h4>
<p>You can add a custom SQL scalar function to SQLite by passing a single
Pure function to <a class="reference internal" href="#sql3::create_function" title="sql3::create_function"><tt class="xref pure pure-func docutils literal"><span class="pre">create_function</span></tt></a>.</p>
<dl class="function">
<dt id="sql3::create_function">
<tt class="descclassname">sql3::</tt><tt class="descname">create_function</tt> dbp::db_ptr name::string nargs::int pure_fun<a class="headerlink" href="#sql3::create_function" title="Permalink to this definition">¶</a></dt>
<dd><p>registers a new SQL scalar function of <tt class="docutils literal"><span class="pre">nargs</span></tt> arguments that can be
called, as <tt class="docutils literal"><span class="pre">name</span></tt>, in SQL statements prepared with respect to <tt class="docutils literal"><span class="pre">dbp</span></tt>, a
db_ptr. When the SQL function is called in a SQL statement, control is
passed to <tt class="docutils literal"><span class="pre">pure_fun</span></tt>, a function written in Pure. If <tt class="docutils literal"><span class="pre">nargs</span></tt> is
<tt class="docutils literal"><span class="pre">(-1)</span></tt>, the SQL function <tt class="docutils literal"><span class="pre">name</span></tt> is variadic, and the arguments will be
passed to <tt class="docutils literal"><span class="pre">pure_fun</span></tt> as a single list.</p>
</dd></dl>

<p>Note that <a class="reference internal" href="#sql3::create_function" title="sql3::create_function"><tt class="xref pure pure-func docutils literal"><span class="pre">create_function</span></tt></a> can also register aggregate functions (see
<a class="reference internal" href="#aggregate-sql-functions">Aggregate SQL Functions</a>).</p>
<p>Here is an example of a scalar function that takes two parameters. Note
that any kind of Pure &#8220;function&#8221; can be passed here; local functions,
global functions, lambdas or partial applications all work.</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span>create_function dbp<span class="p">::</span>dbp <span class="s">&quot;p_fn&quot;</span> <span class="mi">2</span> plus <span class="kr">with</span> plus x y = x + y<span class="p">;</span> <span class="kr">end</span><span class="p">;</span>

<span class="gp">&gt; </span><span class="kr">let</span> sp4 = prep dbp <span class="s">&quot;cii:&quot;</span>
<span class="gp">&gt; </span>          <span class="s">&quot;select p_fn(&#39;Hi &#39;,name), age, p_fn(age,10) from RM&quot;</span><span class="p">;</span>

<span class="gp">&gt; </span>exec sp4 ()<span class="p">;</span>
[[<span class="s">&quot;Hi Sam&quot;</span>,<span class="mi">20</span>,<span class="mi">30</span>],[<span class="s">&quot;Hi Fred&quot;</span>,<span class="mi">22</span>,<span class="mi">32</span>]]
</pre></div>
</div>
<p>Here is an example of a variadic function:</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span>create_function dbp <span class="s">&quot;p_qm&quot;</span> (-<span class="mi">1</span>) quasimodo <span class="kr">with</span>
<span class="gp">&gt; </span>  quasimodo xs = <span class="s">&quot;quasimodo: &quot;</span>+join <span class="s">&quot;:&quot;</span> [str x | x=xs]<span class="p">;</span>
<span class="gp">&gt; </span><span class="kr">end</span><span class="p">;</span>
</pre></div>
</div>
<p>If the SQL function takes no arguments, the corresponding Pure
function must, for technical reasons in Pure, take a single dummy
argument. E.g.,</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span>create_function dbp <span class="s">&quot;p_count&quot;</span> <span class="mi">0</span> counter <span class="kr">with</span>
<span class="gp">&gt; </span>  counter () = put r (get r+<span class="mi">1</span>)<span class="p">;</span>
<span class="gp">&gt; </span><span class="kr">end</span> <span class="kr">when</span> r = ref <span class="mi">0</span> <span class="kr">end</span><span class="p">;</span>
</pre></div>
</div>
<p>Here is how <tt class="docutils literal"><span class="pre">count</span></tt> and <tt class="docutils literal"><span class="pre">quasimodo</span></tt> might be used:</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span><span class="kr">let</span> sp5 = prep dbp <span class="s">&quot;ic:&quot;</span> <span class="s">&quot;select p_count(), p_qm(name,age) from RM&quot;</span><span class="p">;</span>

<span class="gp">&gt; </span>exec sp5 ()<span class="p">;</span>
[[<span class="mi">1</span>,<span class="s">&quot;quasimodo: </span><span class="se">\&quot;</span><span class="s">Sam</span><span class="se">\&quot;</span><span class="s">:20&quot;</span>],[<span class="mi">2</span>,<span class="s">&quot;quasimodo: </span><span class="se">\&quot;</span><span class="s">Fred</span><span class="se">\&quot;</span><span class="s">:22&quot;</span>]]

<span class="gp">&gt; </span>exec sp5 ()<span class="p">;</span>
[[<span class="mi">3</span>,<span class="s">&quot;quasimodo: </span><span class="se">\&quot;</span><span class="s">Sam</span><span class="se">\&quot;</span><span class="s">:20&quot;</span>],[<span class="mi">4</span>,<span class="s">&quot;quasimodo: </span><span class="se">\&quot;</span><span class="s">Fred</span><span class="se">\&quot;</span><span class="s">:22&quot;</span>]]
</pre></div>
</div>
<p>Multiple SQL functions can be registered with the same name if they
have differing numbers of arguments. Built-in SQL functions may be
overloaded or replaced by new application-defined functions.</p>
<p>Generally, a custom function is permitted to call other Sql3 and
native SQLite C interface functions. However, such calls must not
close the database connection nor finalize or reset the prepared
statement in which the function is running.</p>
</div>
<div class="section" id="aggregate-sql-functions">
<h4><a class="toc-backref" href="#id29">Aggregate SQL Functions</a><a class="headerlink" href="#aggregate-sql-functions" title="Permalink to this headline">¶</a></h4>
<p>You can use <a class="reference internal" href="#sql3::create_function" title="sql3::create_function"><tt class="xref pure pure-func docutils literal"><span class="pre">create_function</span></tt></a> to register an aggregate SQL function
with SQLite by passing a triple consisting of two Pure functions and a
start value, in lieu of a single Pure function.</p>
<dl class="function">
<dt>
<tt class="descclassname">sql3::</tt><tt class="descname">create_function</tt> dbp::db_ptr name::string nargs::int (step,final,start)</dt>
<dd><p>registers a new SQL aggregate function of <tt class="docutils literal"><span class="pre">nargs</span></tt> arguments that can be
called, as <tt class="docutils literal"><span class="pre">name</span></tt> in SQL statements prepared with respect to <tt class="docutils literal"><span class="pre">dbp</span></tt>, a
db_ptr.  <tt class="docutils literal"><span class="pre">step</span></tt> and <tt class="docutils literal"><span class="pre">final</span></tt> are curried Pure functions and <tt class="docutils literal"><span class="pre">start</span></tt> is
the initial value for the aggregation. The <tt class="docutils literal"><span class="pre">step</span></tt> function is called
repeatedly to accumulate values from the database, starting from the given
<tt class="docutils literal"><span class="pre">start</span></tt> value, and finally the <tt class="docutils literal"><span class="pre">final</span></tt> function is applied to the
accumulated result.</p>
</dd></dl>

<p>Note that for a single-argument step function, this works exactly as
if the functions were invoked as &#8220;<tt class="docutils literal"><span class="pre">final</span> <span class="pre">(foldl</span> <span class="pre">step</span> <span class="pre">start</span> <span class="pre">values)</span></tt>&#8221;,
where <tt class="docutils literal"><span class="pre">values</span></tt> is the list of aggregated values from the database.</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span>create_function dbp <span class="s">&quot;p_avg&quot;</span> <span class="mi">1</span> (step,final,(<span class="mi">0</span>,<span class="mf">0.0</span>)) <span class="kr">with</span>
<span class="gp">&gt; </span>  step (n,a) x = n+<span class="mi">1</span>, a+x<span class="p">;</span>
<span class="gp">&gt; </span>  final (n,a) = a/n<span class="p">;</span>
<span class="gp">&gt; </span><span class="kr">end</span><span class="p">;</span>

<span class="gp">&gt; </span><span class="kr">let</span> sp6 = prep dbp <span class="s">&quot;id:&quot;</span> <span class="s">&quot;select count(name), p_avg(age) from RM&quot;</span><span class="p">;</span>

<span class="gp">&gt; </span>exec sp6 ()<span class="p">;</span>
[[<span class="mi">2</span>,<span class="mf">21.0</span>]]
</pre></div>
</div>
</div>
</div>
<div class="section" id="accessing-the-rest-of-sqlite-s-c-interface">
<h3><a class="toc-backref" href="#id30">Accessing the Rest of SQLite&#8217;s C Interface</a><a class="headerlink" href="#accessing-the-rest-of-sqlite-s-c-interface" title="Permalink to this headline">¶</a></h3>
<p>The db_ptrs returned by <a class="reference internal" href="#sql3::open" title="sql3::open"><tt class="xref pure pure-func docutils literal"><span class="pre">open</span></tt></a> and stmt_ptrs returned by <a class="reference internal" href="#sql3::prep" title="sql3::prep"><tt class="xref pure pure-func docutils literal"><span class="pre">prep</span></tt></a>
are sentry guarded versions of the actual pointers to the data base
connection objects and prepared statement objects returned by their
corresponding native C interface functions <tt class="docutils literal"><span class="pre">sqlite3_open_v2</span></tt> and
<tt class="docutils literal"><span class="pre">sqlite3_prepare_v2</span></tt>.  This makes it easy to call almost any
external function in SQLite&#8217;s C interface directly, passing it the
same db_ptr or stmt_ptr that is passed to Sql3&#8217;s functions, such as
<a class="reference internal" href="#sql3::prep" title="sql3::prep"><tt class="xref pure pure-func docutils literal"><span class="pre">prep</span></tt></a> or <a class="reference internal" href="#sql3::exec" title="sql3::exec"><tt class="xref pure pure-func docutils literal"><span class="pre">exec</span></tt></a>.</p>
<p>For example, you can override SQLite&#8217;s default behavior with respect
to a busy database as follows:</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span><span class="kr">extern</span> <span class="kt">int</span> sqlite3_busy_timeout(sqlite3*, <span class="kt">int</span>)<span class="p">;</span>

<span class="gp">&gt; </span>sqlite3_busy_timeout dbp <span class="mi">10</span><span class="p">;</span>
</pre></div>
</div>
<p>This sets a busy handler that will &#8220;sleep and retry&#8221; multiple times
until at least 10 milliseconds of sleeping have accumulated.  Calling
this routine with an argument less than or equal to zero turns off all
busy handlers.</p>
<p>Another example is to query the number of database rows that were
changed, inserted or deleted by the most recently completed SQL
statement executed on a given database connection:</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span><span class="kr">extern</span> <span class="kt">int</span> sqlite3_changes(sqlite3*)<span class="p">;</span>

<span class="gp">&gt; </span>exec sp1 (<span class="s">&quot;Harvey&quot;</span>,<span class="mi">30</span>)<span class="p">;</span>

<span class="gp">&gt; </span>sqlite3_changes dbp<span class="p">;</span>
<span class="mi">1</span>
</pre></div>
</div>
<p>As a final example, in this case using a stmt_ptr, you can determine
name assigned to a column in a result using <tt class="docutils literal"><span class="pre">sqlite3_column_name</span></tt>:</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span><span class="kr">extern</span> <span class="kt">char</span> *sqlite3_column_name(sqlite3_stmt*, <span class="kt">int</span>)<span class="p">;</span>

<span class="gp">&gt; </span>exec sp2 <span class="mi">29</span><span class="p">;</span>
[[<span class="s">&quot;Harvey&quot;</span>,<span class="mi">30</span>]]

<span class="gp">&gt; </span>sqlite3_column_name sp2 <span class="mi">1</span><span class="p">;</span>
<span class="s">&quot;age&quot;</span>
</pre></div>
</div>
<p>In order to call a native C function you must first make it accessible
using an extern statement.</p>
<p>Please note also that directly calling a function provided by the
SQLite C interface can be dangerous, as is the case with any call from
Pure code to an external C function.  Sql3 users should be especially
careful in this regard because using a db_ptr or a stmt_ptr in calls
to certain native C interface functions, including in particular
<tt class="docutils literal"><span class="pre">sqlite3_close</span></tt> and <tt class="docutils literal"><span class="pre">sqlite3_finalize</span></tt>, will corrupt data held by
the db_ptr or stmt_ptr, leading to undefined behavior. The reason for
this restriction is that Sql3 uses sentries to insure that the
resources associated with a db_ptr or a stmt_ptr are automatically
finalized by SQLite when they go out of scope. In addition, the
sentries carry internal information used by Sql3 for other purposes.</p>
</div>
<div class="section" id="custom-binding-types-for-prepared-statements">
<h3><a class="toc-backref" href="#id31">Custom Binding Types for Prepared Statements</a><a class="headerlink" href="#custom-binding-types-for-prepared-statements" title="Permalink to this headline">¶</a></h3>
<p>You can add your own binding types for preparing and executing
prepared statements by specifying a third argument to <a class="reference internal" href="#sql3::open" title="sql3::open"><tt class="xref pure pure-func docutils literal"><span class="pre">open</span></tt></a>.  The
third argument must be a list of &#8220;hash rocket pairs&#8221; in which the left
side is a character for the custom binding type and the right side is
a list with three members. The second and third members of the list
are functions that map objects from the new type to one of the Sql3
core types and back, respectively. The first member of the list is the
character for the Sql3 core types referenced by the mapping functions.</p>
<p>The file sql3_user_bind_types.pure in the examples subdirectory shows
how this might be done for a couple of user defined types. The example
script deals with dates and certain Pure expressions as bigints and
native Pure expressions, while the database stores these as utf-8
text. The following snippets show parts of the script that are
relevant to this discussion:</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="kr">const</span> custom_binds = [
  <span class="s">&quot;t&quot;</span>=&gt;[<span class="s">&quot;c&quot;</span>,day_to_str,str_to_day],
  <span class="s">&quot;s&quot;</span>=&gt;[<span class="s">&quot;c&quot;</span>,str,eval]
]<span class="p">;</span>

d1 = str_to_day <span class="s">&quot;2010-03-22&quot;</span><span class="p">;</span>

db = open (<span class="s">&quot;abc.db&quot;</span>, SQLITE_OPEN, custom_binds)<span class="p">;</span>
stm1 = prep db <span class="s">&quot;cts&quot;</span> <span class="s">&quot;insert into TC values(?,?,?)&quot;</span><span class="p">;</span>
exec stm1 [<span class="s">&quot;Manny&quot;</span>, d1, s_expr]<span class="p">;</span>
stm3a = sql3<span class="p">::</span>prep db <span class="s">&quot;t:&quot;</span> <span class="s">&quot;select t_date from TC&quot;</span><span class="p">;</span>
stm3b = sql3<span class="p">::</span>prep db <span class="s">&quot;c:&quot;</span> <span class="s">&quot;select t_date from TC&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Executing stm3a and stm3b from the interpreter shows that TC&#8217;s date
field is stored as a string, but returned to the Pure script as a
bigint.</p>
<div class="highlight-pure"><div class="highlight"><pre><span class="gp">&gt; </span>sql3<span class="p">::</span>exec stm3a ())<span class="p">;</span>
[[<span class="mi">14691L</span>]]

<span class="gp">&gt; </span>sql3<span class="p">::</span>exec stm3b ())<span class="p">;</span>
[[<span class="s">&quot;2010-03-22&quot;</span>]]
</pre></div>
</div>
<p>The character designating the custom type must not be one of the
letters used to designate Sql3 core binding types.</p>
</div>
</div>
<div class="section" id="threading-modes">
<h2><a class="toc-backref" href="#id32">Threading Modes</a><a class="headerlink" href="#threading-modes" title="Permalink to this headline">¶</a></h2>
<p>SQLite supports three different threading modes:</p>
<ol class="arabic simple">
<li>Single-thread. In this mode, all mutexes are disabled and SQLite
is unsafe to use in more than a single thread at once.</li>
<li>Multi-thread. In this mode, SQLite can be safely used by multiple
threads provided that no single database connection is used
simultaneously in two or more threads.</li>
<li>Serialized. In serialized mode, SQLite can be safely used by
multiple threads with no restriction.</li>
</ol>
<p>SQLite can be compiled with or without support for multithreading and
the default is to support it.</p>
<p>In many cases, single-thread mode might be appropriate if only because
it is measurably faster. This might be the case, for example, if you
are using SQLite as the on-disk file format for a desktop application.</p>
<p>If your version of SQLite was compiled with support for
multithreading, you can switch to single-thread mode at runtime by calling
sqlite3_config() with the verb SQLITE_CONFIG_SINGLETHREAD.</p>
<p>If you must use threads, it is anticipated that Sql3 probably will not
impose an additional burden. Hopefully, you will be fine if you apply
the same precautions to a db_ptr or stmt_ptr that you would apply to
the underlying sqlite* and sqlite_stmt*s if you were not using
Sql3. It is strongly advised however that you look at the underlying
Sql3 code to verify that this will work. Since everything that is
imposed between the raw pointers returned by the SQlite interface and
the corresponding db_ptr and stmt_ptrs is written in Pure, it should
be relatively easy to determine how Sql3 and your multithreading
strategy will interact. See <a class="reference external" href="http://www.sqlite.org/faq.html#q6">Is SQLite threadsafe?</a> , <a class="reference external" href="http://www.sqlite.org/c3ref/open.html">Opening A New
Database Connection</a> and <a class="reference external" href="http://www.sqlite.org/c3ref/threadsafe.html">Test To See If The Library Is Threadsafe</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Pure-Sql3</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a><ul>
<li><a class="reference internal" href="#simple-example">Simple Example</a></li>
<li><a class="reference internal" href="#more-examples">More Examples</a></li>
<li><a class="reference internal" href="#sqlite-documentation">SQLite Documentation</a></li>
<li><a class="reference internal" href="#sqlite3-the-sqlite-command-line-utility">Sqlite3 - The SQLite Command-Line Utility</a></li>
</ul>
</li>
<li><a class="reference internal" href="#copying">Copying</a></li>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#data-structure">Data Structure</a></li>
<li><a class="reference internal" href="#core-database-operations">Core Database Operations</a><ul>
<li><a class="reference internal" href="#database-connections">Database Connections</a><ul>
<li><a class="reference internal" href="#opening-a-database-connection">Opening a Database Connection</a></li>
<li><a class="reference internal" href="#failure-to-open-a-database-connection">Failure to Open a Database Connection</a></li>
<li><a class="reference internal" href="#testing-a-db-ptr">Testing a db_ptr</a></li>
<li><a class="reference internal" href="#closing-a-database-connection">Closing a Database Connection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#prepared-statements">Prepared Statements</a><ul>
<li><a class="reference internal" href="#constructing-prepared-statements">Constructing Prepared Statements</a></li>
<li><a class="reference internal" href="#testing-a-stmt-ptr">Testing a stmt_ptr</a></li>
<li><a class="reference internal" href="#executing-prepared-statements">Executing Prepared Statements</a></li>
<li><a class="reference internal" href="#executing-lazily">Executing Lazily</a></li>
<li><a class="reference internal" href="#executing-directly-on-a-db-ptr">Executing Directly on a db_ptr</a></li>
<li><a class="reference internal" href="#executing-against-a-busy-database">Executing Against a Busy Database</a></li>
<li><a class="reference internal" href="#grouping-execution-with-transactions">Grouping Execution with Transactions</a></li>
<li><a class="reference internal" href="#finalizing-prepared-statements">Finalizing Prepared Statements</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exceptions">Exceptions</a><ul>
<li><a class="reference internal" href="#sqlite-error-codes">SQLite Error Codes</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-features">Advanced Features</a><ul>
<li><a class="reference internal" href="#custom-sql-functions">Custom SQL Functions</a><ul>
<li><a class="reference internal" href="#scalar-sql-functions">Scalar SQL Functions</a></li>
<li><a class="reference internal" href="#aggregate-sql-functions">Aggregate SQL Functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#accessing-the-rest-of-sqlite-s-c-interface">Accessing the Rest of SQLite&#8217;s C Interface</a></li>
<li><a class="reference internal" href="#custom-binding-types-for-prepared-statements">Custom Binding Types for Prepared Statements</a></li>
</ul>
</li>
<li><a class="reference internal" href="#threading-modes">Threading Modes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="pure-odbc.html"
                        title="previous chapter">Pure-ODBC - ODBC interface for the Pure programming language</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="pure-xml.html"
                        title="next chapter">Pure-XML - XML/XSLT interface</a></p>
<h3>This Page</h3>
<ul class="this-page-menu">
  <li><a href="bugs.html">Report a Bug</a></li>
  <li><a href="_sources/pure-sql3.txt"
         rel="nofollow">Show Source</a></li>
</ul>

<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="pure-modindex.html" title="Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="pure-xml.html" title="Pure-XML - XML/XSLT interface"
             >next</a> |</li>
        <li class="right" >
          <a href="pure-odbc.html" title="Pure-ODBC - ODBC interface for the Pure programming language"
             >previous</a> |</li>
        <li><a href="index.html">Pure Language and Library Documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
    &copy; Copyright 2009-2013, Albert Gräf et al.
    Last updated on Sep 08, 2013.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>

  </body>
</html>